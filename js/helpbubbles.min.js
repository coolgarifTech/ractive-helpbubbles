/** Ractive-HelpBubbles - v0.1 - 2013-09-02
* Helpful page-hints using Ractive.js

* https://github.com/coolgarifTech/ractive-helpbubbles
* Author: James Billot, Coolgarif Tech Ltd.
* Copyright (c) 2013 Coolgarif Tech Ltd;
* @license Licensed MIT */
(function(global){"use strict";var HelpBubbles,template,VERSION="0.1";function offset(element){var body=document.body,win=document.defaultView,docElem=document.documentElement,box=document.createElement("div");box.style.paddingLeft=box.style.width="1px";body.appendChild(box);var isBoxModel=box.offsetWidth==2;body.removeChild(box);box=element.getBoundingClientRect();var clientTop=docElem.clientTop||body.clientTop||0,clientLeft=docElem.clientLeft||body.clientLeft||0,scrollTop=win.pageYOffset||isBoxModel&&docElem.scrollTop||body.scrollTop,scrollLeft=win.pageXOffset||isBoxModel&&docElem.scrollLeft||body.scrollLeft;return{top:box.top+scrollTop-clientTop,left:box.left+scrollLeft-clientLeft}}function centrePointElement(element){var o=offset(element);o.centre_x=o.left+element.offsetWidth/2;o.centre_y=o.top+element.offsetHeight/2;return o}function centrePointSVGElement(element){var o=offset(element);var d=element.getBBox();o.centre_x=o.left+d.width/2;o.centre_y=o.top+d.height/2;return o}function centrePoint(element){return element instanceof SVGElement?centrePointSVGElement(element):centrePointElement(element)}template='        {{#can_show}}        {{#current_bubble}}        <div class="help-bubble{{#reversed}}--reversed{{/reversed}}" style="top:{{ y + y_adjustment }}px;{{#reversed}}right{{/reversed}}{{^reversed}}left{{/reversed}}:{{ x + x_adjustment }}px;" on-tap="bubbletap"><p class="help-bubble__content">{{ content }}</p></div>        {{/current_bubble}}        {{/can_show}}    ';HelpBubbles=Ractive.extend({template:template,data:{bubbles:[],days_to_remember_cookie:10,x_adjustment:0,y_adjustment:0,can_show:true,current_bubble:false},nextBubble:null,init:function init(){var self=this,observe_functions={},resizeHandler;observe_functions.bubbles=function observeBubbles(bubbles){this.doBubbles()};this.observe(observe_functions,{init:false});this.on("bubbletap",function(event){this.data.current_bubble.onTap();this.nextBubble()});window.addEventListener("resize",resizeHandler=function(){self.resize()});this.on("teardown",function(){window.removeEventListener("resize",resizeHandler)});this.resize();this.set("can_show",!this.cookieExists());if(!this.data.can_show){return}this.setCookie(this.data.days_to_remember_cookie);this.doBubbles()},bubbleDisplayData:function bubbleDisplayData(bubble){var positions=centrePoint(document.getElementById(bubble.target));var data={content:bubble.content,onTap:bubble["onTap"]===undefined?function noop(){}:bubble.onTap,x:positions.centre_x,y:positions.centre_y};if(bubble.reversed){data.reversed=true;data.x=document.body.offsetWidth-data.x}return data},bubbleIterator:function bubbleIterator(bubbles){var self=this,my_bubbles=_.cloneDeep(bubbles);return function nextBubble(){if(my_bubbles.length<1)return self.set("current_bubble",false);var raw_next_bubble=my_bubbles.shift();if(raw_next_bubble["pause"]){var t=window.setTimeout(function(){self.set("current_bubble",self.bubbleDisplayData(raw_next_bubble));window.clearTimeout(t)},raw_next_bubble.pause*1e3);self.set("current_bubble",false);return}self.set("current_bubble",self.bubbleDisplayData(raw_next_bubble))}},cookieExists:function cookieExists(){return document.cookie.search(/(^|;)helpbubblesseen=/)>-1},doBubbles:function doBubbles(){this.set("can_show",true);this.nextBubble=this.bubbleIterator(this.data.bubbles);this.nextBubble()},resize:function resize(){var width,height;width=this.el.clientWidth;height=this.el.clientHeight;this.set({width:width,height:height})},setCookie:function setCookie(days){document.cookie="helpbubblesseen=true;max-age="+86400*days}});HelpBubbles.VERSION=VERSION;global.HelpBubbles=HelpBubbles})(typeof window!=="undefined"?window:this);